@page "/schedule"

@using StudyHub.DAL.Entities
@using StudyHub.DAL.Repositories
@using StudyHub.BLL.Services
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.Maui.Storage
@inject StudyHub.BLL.Services.ScheduleService ScheduleService
@inject StudyHub.BLL.Services.IScheduleDownloaderService DownloaderService
@inject StudyHub.BLL.Services.UniversityService UniversityServ
@inject IBaseRepository<LessonSlots> SlotsRepo
@inject IBaseRepository<Schedule> ScheduleRepo
@inject IJSRuntime JS
@inject ILogger<Schedule> Logger
@using System.Threading.Tasks
@using System.Linq
@using System.IO

<div class="schedule-container">
    <div class="schedule-header">
        <div class="schedule-header-left">
            <select class="week-select">
                <option value="current">Цей тиждень</option>
                <option value="next">Наступний тиждень</option>
            </select>

            <select class="group-select" value="@currentGroupName" @onchange="OnGroupChanged">
                @if (AvailableGroups == null || !AvailableGroups.Any())
                {
                    <option disabled>Немає груп</option>
                }
                else
                {
                    @foreach (var group in AvailableGroups)
                    {
                        <option value="@group">@group</option>
                    }
                }
            </select>
        </div>

        @if (isLoading)
        {
            <div class="loading-spinner">Оновлення...</div>
        }
        else
        {
            <button class="refresh-schedule-btn" @onclick="@(async () => await DownloadAndParseFromWebAsync())">
                <span class="refresh-icon">🔄</span>
                Оновити з сайту
            </button>
        }
    </div>

    @if (isLoading && !HasScheduleData)
    {
        <div class="loading-overlay">
            <p>Завантаження розкладу...</p>
        </div>
    }
    else
    {
        <div class="schedule-table-wrapper">
            <table class="schedule-table">
                <thead>
                    <tr>
                        <th class="time-column"></th>
                        @foreach (var day in Days)
                        {
                            <th>@day</th>
                        }
                    </tr>
                </thead>
                <tbody>
                    @foreach (var slot in TimeSlots)
                    {
                        var slotKey = $"{slot.Start:HH:mm} - {slot.End:HH:mm}";

                        <tr>
                            <td class="time-cell">@slotKey</td>

                            @foreach (var day in Days)
                            {
                                <td class="lesson-cell">
                                    @if (RenderedSchedule.ContainsKey(day) && RenderedSchedule[day].ContainsKey(slotKey))
                                    {
                                        foreach (var lesson in RenderedSchedule[day][slotKey])
                                        {
                                            var typeClass = GetTypeClass(lesson.Type);

                                            <div class="lesson-card @typeClass">
                                                <div class="lesson-type">@lesson.Type</div>
                                                <div class="lesson-subject">@(lesson.Subject?.Name ?? "Без назви")</div>

                                                <div class="lesson-footer">
                                                    <div class="lesson-room">@lesson.Room</div>
                                                    @if (lesson.Lecturer != null && lesson.Lecturer.Any())
                                                    {
                                                        <div class="lesson-lecturer">
                                                            @string.Join(", ", lesson.Lecturer.Select(l => $"{l.Surname} {l.Name}"))
                                                        </div>
                                                    }
                                                </div>
                                            </div>
                                        }
                                    }
                                </td>
                            }
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }

</div>

@code {
    private bool isLoading = true;
    private bool HasScheduleData => RenderedSchedule.Count > 0;
    private string currentGroupName = "Невідома група";

    private Dictionary<string, Dictionary<string, List<Lesson>>> RenderedSchedule = new();
    private List<string> Days = new();
    private List<LessonSlots> TimeSlots = new();

    private List<string> AvailableGroups = new();


    private async System.Threading.Tasks.Task OnGroupChanged(ChangeEventArgs e)
    {
        var newGroup = e.Value?.ToString();

        if (!string.IsNullOrEmpty(newGroup) && newGroup != currentGroupName)
        {
            Logger.LogInformation("Зміна групи: {OldGroup} -> {NewGroup}", currentGroupName, newGroup);

            currentGroupName = newGroup;
            Preferences.Set("GroupName", currentGroupName);

            isLoading = true;

            try
            {
                await LoadScheduleFromDb();
                Logger.LogInformation("Розклад успішно завантажено для групи: {Group}", currentGroupName);
            }
            catch (Exception ex)
            {
                Logger.LogError(ex, "Помилка зміни групи: {Group}", newGroup);
            }
            finally
            {
                isLoading = false;
            }
        }
    }


    protected override async System.Threading.Tasks.Task OnInitializedAsync()
    {
        Logger.LogInformation("Ініціалізація сторінки розкладу");

        try
        {
            isLoading = true;
            Days = new List<string> { "Понеділок", "Вівторок", "Середа", "Четвер", "П'ятниця" };

            var slotsFromDb = await SlotsRepo.GetAll();
            TimeSlots = slotsFromDb.OrderBy(s => s.Start).ToList();
            Logger.LogInformation("Завантажено {SlotsCount} часових слотів", TimeSlots.Count);

            var allSchedules = await ScheduleRepo.GetAll();

            AvailableGroups = allSchedules
                .Select(s => s.GroupName)
                .Where(n => !string.IsNullOrWhiteSpace(n))
                .Distinct()
                .OrderBy(n => n)
                .ToList();

            Logger.LogInformation("Знайдено {GroupCount} доступних груп", AvailableGroups.Count);

            currentGroupName = Preferences.Get("GroupName", AvailableGroups.FirstOrDefault() ?? "ПМІ-31с");
            Logger.LogInformation("Поточна група: {Group}", currentGroupName);

            if (!string.IsNullOrEmpty(currentGroupName))
            {
                await LoadScheduleFromDb();
            }

            Logger.LogInformation("Ініціалізація сторінки розкладу завершена успішно");
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Помилка ініціалізації сторінки розкладу");
            await JS.InvokeVoidAsync("alert", $"Помилка ініціалізації: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private async System.Threading.Tasks.Task LoadScheduleFromDb()
    {
        Logger.LogInformation("Завантаження розкладу з БД для групи: {Group}", currentGroupName);

        try
        {
            System.Collections.Generic.List<StudyHub.DAL.Entities.Schedule> allSchedules = await ScheduleRepo.GetAll();
            StudyHub.DAL.Entities.Schedule? mySchedule = allSchedules.FirstOrDefault(s => s.GroupName == currentGroupName);

            if (mySchedule != null && mySchedule.Lessons != null && mySchedule.Lessons.Any())
            {
                UpdateRenderedSchedule(mySchedule.Lessons);
                Logger.LogInformation("Розклад завантажено: {LessonCount} занять для групи {Group}",
                    mySchedule.Lessons.Count, currentGroupName);
            }
            else
            {
                RenderedSchedule.Clear();
                Logger.LogWarning("Розклад не знайдено для групи: {Group}", currentGroupName);
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Помилка завантаження розкладу з БД: {Group}", currentGroupName);
            throw;
        }
    }

    private void UpdateRenderedSchedule(List<Lesson> lessons)
    {
        Logger.LogDebug("Оновлення відображуваного розкладу: {LessonCount} занять", lessons.Count);

        RenderedSchedule = lessons
            .GroupBy(l => l.Day)
            .ToDictionary(
                g => g.Key,
                g => g.GroupBy(l =>
                    l.LessonSlot != null
                        ? $"{l.LessonSlot.Start:HH:mm} - {l.LessonSlot.End:HH:mm}"
                        : "Невідомий час")
                      .ToDictionary(sg => sg.Key, sg => sg.ToList())
            );

        Logger.LogDebug("Розклад згруповано по {DayCount} днях", RenderedSchedule.Count);
    }

    private string GetTypeClass(string type)
    {
        if (string.IsNullOrEmpty(type)) return "";

        type = type.ToLower();
        if (type.Contains("лек")) return "lesson-type-l";
        if (type.Contains("прак") || type.Contains("лаб")) return "lesson-type-p";
        if (type.Contains("сем")) return "lesson-type-s";

        return "";
    }


    private async System.Threading.Tasks.Task DownloadAndParseFromWebAsync()
    {
        Logger.LogInformation("Початок оновлення розкладу з сайту для групи: {Group}", currentGroupName);

        if (string.IsNullOrEmpty(currentGroupName))
        {
            Logger.LogWarning("Спроба оновлення розкладу без встановленої групи");
            await JS.InvokeVoidAsync("alert", "Не встановлена група в налаштуваннях!");
            return;
        }

        isLoading = true;

        try
        {
            var facultyInfo = UniversityServ.GetFacultyByGroup(currentGroupName);

            string pdfPath = await DownloaderService.DownloadSchedulePdfAsync(facultyInfo, currentGroupName);
            Logger.LogInformation("PDF завантажено: {PdfPath}", pdfPath);

            await RunParserAsync(pdfPath);

            Logger.LogInformation("Розклад успішно оновлено з сайту для групи: {Group}", currentGroupName);
            await JS.InvokeVoidAsync("alert", "Розклад успішно оновлено!");
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Помилка оновлення розкладу з сайту: {Group}", currentGroupName);
            await JS.InvokeVoidAsync("alert", $"Помилка оновлення: {ex.Message}");
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async System.Threading.Tasks.Task HandleFileUploadAsync(InputFileChangeEventArgs e)
    {
        var file = e.File;
        if (file == null) return;

        Logger.LogInformation("Завантаження файлу розкладу: {FileName}, Розмір: {FileSize} bytes",
            file.Name, file.Size);

        var folder = Path.Combine(AppContext.BaseDirectory, "Resources", "Schedules");
        if (!Directory.Exists(folder)) Directory.CreateDirectory(folder);

        var filePath = Path.Combine(folder, file.Name);

        isLoading = true;
        try
        {
            using var fs = new FileStream(filePath, FileMode.Create);
            await file.OpenReadStream().CopyToAsync(fs);

            Logger.LogInformation("Файл збережено: {FilePath}", filePath);

            await RunParserAsync(filePath);

            Logger.LogInformation("Розклад успішно оновлено з файлу: {FileName}", file.Name);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Помилка обробки файлу: {FileName}", file.Name);
            await JS.InvokeVoidAsync("alert", $"Помилка файлу: {ex.Message}");
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async System.Threading.Tasks.Task RunParserAsync(string filePath)
    {
        Logger.LogInformation("Запуск парсера розкладу: {FilePath}, Група: {Group}", filePath, currentGroupName);

        try
        {
            var schedule = await ScheduleService.ParseScheduleAsync(filePath, currentGroupName);

            UpdateRenderedSchedule(schedule.Lessons);

            var freshSlots = await SlotsRepo.GetAll();
            TimeSlots = freshSlots.OrderBy(s => s.Start).ToList();

            Logger.LogInformation("Парсинг завершено успішно: {LessonCount} занять, {SlotCount} слотів",
                schedule.Lessons.Count, TimeSlots.Count);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Помилка парсингу розкладу: {FilePath}, Група: {Group}", filePath, currentGroupName);
            throw;
        }
    }
}