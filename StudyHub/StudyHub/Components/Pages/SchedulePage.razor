@page "/schedule"

@using StudyHub.DAL.Entities
@using StudyHub.DAL.Repositories
@using StudyHub.BLL.Services
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.Maui.Storage
@inject StudyHub.BLL.Services.ScheduleService ScheduleService
@inject StudyHub.BLL.Services.IScheduleDownloaderService DownloaderService
@inject StudyHub.BLL.Services.UniversityService UniversityServ
@inject IBaseRepository<LessonSlots> SlotsRepo
@inject IBaseRepository<Schedule> ScheduleRepo
@inject IJSRuntime JS
@using System.Threading.Tasks
@using System.Linq
@using System.IO

<div class="schedule-container">
    <div class="schedule-header">
        @if (isLoading)
        {
            <div class="loading-spinner">Оновлення...</div>
        }
        else
        {
            <button class="refresh-schedule-btn" @onclick="@(async () => await DownloadAndParseFromWebAsync())">
                <span class="refresh-icon">🔄</span>
                Оновити з сайту
            </button>
        }
    </div>

    @if (isLoading && !HasScheduleData)
    {
        <div class="loading-overlay">
            <p>Завантаження розкладу...</p>
        </div>
    }
    else
    {
        <div class="schedule-table-wrapper">
            <table class="schedule-table">
                <thead>
                    <tr>
                        <th class="time-column"></th>
                        @foreach (var day in Days)
                        {
                            <th>@day</th>
                        }
                    </tr>
                </thead>
                <tbody>
                    @foreach (var slot in TimeSlots)
                    {
                        var slotKey = $"{slot.Start:HH:mm} - {slot.End:HH:mm}";

                        <tr>
                            <td class="time-cell">@slotKey</td>

                            @foreach (var day in Days)
                            {
                                <td class="lesson-cell">
                                    @if (RenderedSchedule.ContainsKey(day) && RenderedSchedule[day].ContainsKey(slotKey))
                                    {
                                        foreach (var lesson in GetUniqueLessons(RenderedSchedule[day][slotKey]))
                                        {
                                            var typeClass = GetTypeClass(lesson.Type);

                                            <div class="lesson-card @typeClass">
                                                <div class="lesson-type">@GetTypeShortLabel(lesson.Type)</div>
                                                <div class="lesson-subject">@(lesson.Subject?.Name ?? "Без назви")</div>

                                                <div class="lesson-footer">
                                                    <div class="lesson-room">@lesson.Room</div>
                                                    @if (lesson.Lecturer != null && lesson.Lecturer.Any())
                                                    {
                                                        <div class="lesson-lecturer">
                                                            @string.Join(", ", lesson.Lecturer.Select(l => $"{l.Surname} {l.Name}"))
                                                        </div>
                                                    }
                                                </div>
                                            </div>
                                        }
                                    }
                                </td>
                            }
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }

</div>

@code {
    private bool isLoading = true;
    private bool HasScheduleData => RenderedSchedule.Count > 0;
    private string currentGroupName = "Невідома група";

    // Дані для відображення
    private Dictionary<string, Dictionary<string, List<Lesson>>> RenderedSchedule = new();
    private List<string> Days = new();
    private List<LessonSlots> TimeSlots = new();

    protected override async System.Threading.Tasks.Task OnInitializedAsync()
    {
        try
        {
            isLoading = true;
            Days = new List<string> { "Понеділок", "Вівторок", "Середа", "Четвер", "П'ятниця" };

            var slotsFromDb = await SlotsRepo.GetAll();
            TimeSlots = slotsFromDb.OrderBy(s => s.Start).ToList();

            currentGroupName = Preferences.Get("GroupName", "ПМІ-31с");

            if (!string.IsNullOrEmpty(currentGroupName))
            {
                await LoadScheduleFromDb();
            }
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"Помилка ініціалізації: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private async System.Threading.Tasks.Task LoadScheduleFromDb()
    {
        System.Collections.Generic.List<StudyHub.DAL.Entities.Schedule> allSchedules = await ScheduleRepo.GetAll();
        StudyHub.DAL.Entities.Schedule? mySchedule = allSchedules.FirstOrDefault(s => s.GroupName == currentGroupName);

        if (mySchedule != null && mySchedule.Lessons != null && mySchedule.Lessons.Any())
        {
            UpdateRenderedSchedule(mySchedule.Lessons);
        }
        else
        {
            RenderedSchedule.Clear();
        }
    }

    private void UpdateRenderedSchedule(List<Lesson> lessons)
    {
        RenderedSchedule = lessons
            .GroupBy(l => l.Day)
            .ToDictionary(
                g => g.Key,
                g => g.GroupBy(l =>
                    l.LessonSlot != null
                        ? $"{l.LessonSlot.Start:HH:mm} - {l.LessonSlot.End:HH:mm}"
                        : "Невідомий час")
                      .ToDictionary(sg => sg.Key, sg => sg.ToList())
            );
    }

    private string GetTypeClass(string type)
    {
        if (string.IsNullOrEmpty(type) || type.Trim() == "-") 
            return "lesson-type-unknown";

        type = type.ToLower();
        if (type.Contains("лек")) return "lesson-type-l";
        if (type.Contains("прак") || type.Contains("лаб")) return "lesson-type-p";
        if (type.Contains("сем")) return "lesson-type-s";

        return "lesson-type-unknown";
    }

    private string GetTypeShortLabel(string type)
    {
        if (string.IsNullOrEmpty(type)) return "";

        type = type.ToLower();
        if (type.Contains("лек")) return "Л";
        if (type.Contains("прак") || type.Contains("лаб")) return "П";
        if (type.Contains("сем")) return "С";

        return type;
    }

    private List<Lesson> GetUniqueLessons(List<Lesson> lessons)
    {
        if (lessons == null || !lessons.Any())
            return new List<Lesson>();

        var uniqueLessons = new List<Lesson>();
        
        foreach (var lesson in lessons)
        {
            bool isDuplicate = uniqueLessons.Any(ul =>
                ul.Subject?.Name == lesson.Subject?.Name &&
                ul.Type == lesson.Type &&
                ul.Room == lesson.Room &&
                ul.Day == lesson.Day);

            if (!isDuplicate)
            {
                uniqueLessons.Add(lesson);
            }
        }

        return uniqueLessons;
    }


    private async System.Threading.Tasks.Task DownloadAndParseFromWebAsync()
    {
        if (string.IsNullOrEmpty(currentGroupName))
        {
            await JS.InvokeVoidAsync("alert", "Не встановлена група в налаштуваннях!");
            return;
        }

        isLoading = true;

        try
        {
            var facultyInfo = UniversityServ.GetFacultyByGroup(currentGroupName);

            string pdfPath = await DownloaderService.DownloadSchedulePdfAsync(facultyInfo, currentGroupName);

            await RunParserAsync(pdfPath);

            await JS.InvokeVoidAsync("alert", "Розклад успішно оновлено!");
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"Помилка оновлення: {ex.Message}");
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async System.Threading.Tasks.Task HandleFileUploadAsync(InputFileChangeEventArgs e)
    {
        var file = e.File;
        if (file == null) return;

        var folder = Path.Combine(AppContext.BaseDirectory, "Resources", "Schedules");
        if (!Directory.Exists(folder)) Directory.CreateDirectory(folder);

        var filePath = Path.Combine(folder, file.Name);
        using var fs = new FileStream(filePath, FileMode.Create);
        await file.OpenReadStream().CopyToAsync(fs);

        isLoading = true;
        try
        {
            await RunParserAsync(filePath);
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"Помилка файлу: {ex.Message}");
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async System.Threading.Tasks.Task RunParserAsync(string filePath)
    {
        var schedule = await ScheduleService.ParseScheduleAsync(filePath, currentGroupName);

        UpdateRenderedSchedule(schedule.Lessons);

        var freshSlots = await SlotsRepo.GetAll();
        TimeSlots = freshSlots.OrderBy(s => s.Start).ToList();
    }
}