@page "/taskboard"
@using StudyHub.BLL.Models
@using StudyHub.BLL.Services
@using StudyHub.DAL.Entities
@inject ITaskService TaskService
@inject AuthStateService AuthState
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime

<div class="taskboard-container" @onclick="CloseFilterDropdown">
    <div class="taskboard-header">
        <div class="search-wrapper">
            <span class="search-icon">🔍</span>
            <input type="text"
                   placeholder="Search"
                   @bind="searchQuery"
                   @bind:event="oninput"
                   class="taskboard-search" />
        </div>

        <button class="filter-btn" @onclick="ToggleFilterDropdown" @onclick:stopPropagation="true">
            <span class="filter-icon">☰</span>
            Filter By
        </button>

        <button class="create-task-btn" @onclick="OpenCreateTaskModal">
            Create Task
        </button>
    </div>

    @if (isLoading)
    {
        <div class="alert alert-info" style="text-align: center; margin: 15px 0;">Завантаження завдань...</div>
    }
    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="alert alert-danger" style="text-align: center; margin: 15px 0; color: red;">@errorMessage</div>
    }

    @if (showFilterDropdown)
    {
        <div class="filter-dropdown" @onclick:stopPropagation="true">
            <div class="filter-option @(string.IsNullOrEmpty(filterSubject) ? "filter-active" : "")" @onclick="HandleFilterAll">
                All Subjects (@tasks.Count)
            </div>
            @foreach (var subject in GetUniqueSubjects())
            {
                var count = tasks.Count(t => t.Subject == subject);
                <div class="filter-option @(filterSubject == subject ? "filter-active" : "")" @onclick="() => SetFilter(subject)">
                    @subject (@count)
                </div>
            }
        </div>
    }

    <div class="kanban-board">
        <div class="kanban-column">
            <div class="column-header">
                <h3>To Do</h3>
                <span class="task-count">@GetTasksByStatus("To Do").Count()</span>
            </div>
            <div class="column-content">
                @foreach (var task in GetTasksByStatus("To Do"))
                {
                    var currentTask = task;
                    <div class="task-card" @onclick="@(() => OpenTaskDetails(currentTask))">
                        <div class="task-card-header">
                            <h4>@task.Name</h4>
                            <span class="task-status-icon" style="@GetStatusIconColor(task)">@GetStatusIcon(task)</span>
                        </div>
                        <p class="task-subject">@task.Subject</p>
                        <div class="task-card-footer">
                            <span class="task-code">@task.Code</span>
                            <span class="task-avatar">👤</span>
                        </div>
                    </div>
                }
            </div>
        </div>

        <div class="kanban-column">
            <div class="column-header">
                <h3>In Progress</h3>
                <span class="task-count">@GetTasksByStatus("In Progress").Count()</span>
            </div>
            <div class="column-content">
                @foreach (var task in GetTasksByStatus("In Progress"))
                {
                    var currentTask = task;
                    <div class="task-card" @onclick="@(() => OpenTaskDetails(currentTask))">
                        <div class="task-card-header">
                            <h4>@task.Name</h4>
                            <span class="task-status-icon" style="@GetStatusIconColor(task)">@GetStatusIcon(task)</span>
                        </div>
                        <p class="task-subject">@task.Subject</p>
                        <div class="task-card-footer">
                            <span class="task-code">@task.Code</span>
                            <span class="task-avatar">👤</span>
                        </div>
                    </div>
                }
            </div>
        </div>

        <div class="kanban-column">
            <div class="column-header">
                <h3>For Review</h3>
                <span class="task-count">@GetTasksByStatus("For Review").Count()</span>
            </div>
            <div class="column-content">
                @foreach (var task in GetTasksByStatus("For Review"))
                {
                    var currentTask = task;
                    <div class="task-card" @onclick="@(() => OpenTaskDetails(currentTask))">
                        <div class="task-card-header">
                            <h4>@task.Name</h4>
                            <span class="task-status-icon" style="@GetStatusIconColor(task)">@GetStatusIcon(task)</span>
                        </div>
                        <p class="task-subject">@task.Subject</p>
                        <div class="task-card-footer">
                            <span class="task-code">@task.Code</span>
                            <span class="task-avatar">👤</span>
                        </div>
                    </div>
                }
            </div>
        </div>

        <div class="kanban-column">
            <div class="column-header">
                <h3>Done</h3>
                <span class="task-count">@GetTasksByStatus("Done").Count()</span>
            </div>
            <div class="column-content">
                @foreach (var task in GetTasksByStatus("Done"))
                {
                    var currentTask = task;
                    <div class="task-card task-card-done" @onclick="@(() => OpenTaskDetails(currentTask))">
                        <div class="task-card-header">
                            <h4>@task.Name</h4>
                            <span class="task-status-icon" style="@GetStatusIconColor(task)">@GetStatusIcon(task)</span>
                        </div>
                        <p class="task-subject">@task.Subject</p>
                        <div class="task-card-footer">
                            <span class="task-code">@task.Code</span>
                            <span class="task-avatar">👤</span>
                        </div>
                    </div>
                }
            </div>
        </div>
    </div>

    @if (showCreateModal)
    {
        <div class="modal-overlay" @onclick="CloseCreateTaskModal">
            <div class="modal-content" @onclick:stopPropagation>
                <div class="modal-header">
                    <h2>Create Task</h2>
                    <button class="modal-close" @onclick="CloseCreateTaskModal">×</button>
                </div>

                <div class="modal-body">
                    <div class="form-group">
                        <label>Task Name</label>
                        <input @bind="newTaskName"
                               placeholder="Name your task..."
                               class="form-input" />
                    </div>

                    <div class="form-group">
                        <label>Description</label>
                        <textarea @bind="newTaskDescription"
                                  placeholder="Please describe what needs to be done..."
                                  rows="4"
                                  class="form-textarea"></textarea>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Subject</label>
                            <select @bind="newTaskSubject" class="form-select">
                                <option value="">Choose subject</option>
                                <option value="Subject A">Subject A</option>
                                <option value="Subject B">Subject B</option>
                                <option value="Subject C">Subject C</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label>Due Date</label>
                            <input type="date" @bind="newTaskDueDate" class="form-input" />
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Reminder</label>
                        <div class="reminder-input">
                            <input type="number" @bind="newTaskReminderDays" class="form-input-small" />
                            <span>days before due date</span>
                        </div>
                    </div>
                </div>

                <div class="modal-footer">
                    <button @onclick="CloseCreateTaskModal" class="btn-secondary">Cancel</button>
                    <button @onclick="CreateNewTask" class="btn-primary" disabled="@isLoading">Create</button>
                </div>
            </div>
        </div>
    }

    @if (selectedTask != null)
    {
        <div class="modal-overlay" @onclick="CloseTaskDetails">
            <div class="modal-content modal-content-large" @onclick:stopPropagation>
                <div class="modal-header">
                    <div>
                        <h2>@selectedTask.Name</h2>
                        <p class="task-code-detail">@selectedTask.Code</p>
                    </div>
                    <button class="modal-close" @onclick="CloseTaskDetails">×</button>
                </div>

                <div class="modal-body">
                    <div class="form-group">
                        <label>Task Name</label>
                        @if (isEditMode)
                        {
                            <input type="text" @bind="editTaskName" class="form-input" placeholder="Enter task name" />
                        }
                        else
                        {
                            <p class="form-value">@selectedTask.Name</p>
                        }
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Subject</label>
                            @if (isEditMode)
                            {
                                <select @bind="editTaskSubject" class="form-select">
                                    <option value="Subject A">Subject A</option>
                                    <option value="Subject B">Subject B</option>
                                    <option value="Subject C">Subject C</option>
                                </select>
                            }
                            else
                            {
                                <p class="form-value">@selectedTask.Subject</p>
                            }
                        </div>
                        <div class="form-group">
                            <label>Status</label>
                            <select @bind="selectedTaskStatus" class="form-select">
                                <option value="To Do">To Do</option>
                                <option value="In Progress">In Progress</option>
                                <option value="For Review">For Review</option>
                                <option value="Done">Done</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Due Date</label>
                            @if (isEditMode)
                            {
                                <input type="date" @bind="editTaskDueDate" class="form-input" />
                            }
                            else
                            {
                                <p class="form-value">@(selectedTask.DueDate?.ToString("dd/MM/yyyy") ?? "Not set")</p>
                            }
                        </div>
                        <div class="form-group">
                            <label>Creation Date</label>
                            <p class="form-value">@selectedTask.CreationDate.ToString("dd/MM/yyyy")</p>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Description</label>
                        @if (isEditMode)
                        {
                            <textarea @bind="editTaskDescription" rows="4" class="form-textarea" placeholder="Enter description"></textarea>
                        }
                        else
                        {
                            <div class="description-box">
                                <p>@selectedTask.Description</p>
                            </div>
                        }
                    </div>

                    <div class="form-group">
                        <label>Comments (@taskComments.Count)</label>
                        @if (taskComments.Any())
                        {
                            <div class="comments-list">
                                @foreach (var comment in taskComments)
                                {
                                    <div class="comment-item">
                                        <div class="comment-header">
                                            <strong>@comment.AuthorName</strong>
                                            <div>
                                                <small>@comment.CreationDate.ToString("dd/MM/yyyy HH:mm")</small>
                                                @if (comment.UserId == AuthState.UserId)
                                                {
                                                    @if (editingCommentId == comment.Id)
                                                    {
                                                        <button class="btn-icon" @onclick="() => CancelEditComment()" title="Cancel">
                                                            ✖
                                                        </button>
                                                    }
                                                    else
                                                    {
                                                        <button class="btn-icon" @onclick="() => StartEditComment(comment)" title="Edit">
                                                            ✏️
                                                        </button>
                                                        <button class="btn-icon btn-icon-danger" @onclick="() => DeleteComment(comment.Id)" title="Delete">
                                                            🗑️
                                                        </button>
                                                    }
                                                }
                                            </div>
                                        </div>

                                        @if (editingCommentId == comment.Id)
                                        {
                                            <textarea @bind="editingCommentText"
                                                      rows="3"
                                                      class="form-textarea"
                                                      style="margin-bottom: 8px;"></textarea>
                                            <button class="btn-primary btn-small"
                                                    @onclick="SaveEditComment"
                                                    disabled="@isLoading">
                                                Save
                                            </button>
                                        }
                                        else
                                        {
                                            <p class="comment-text">@comment.Description</p>
                                        }
                                    </div>
                                }
                            </div>
                        }
                        else
                        {
                            <p class="no-comments">No comments yet. Be the first to comment!</p>
                        }

                        <textarea placeholder="Add a comment..."
                                  rows="3"
                                  class="form-textarea"
                                  @bind="taskNotes"
                                  style="margin-top: 10px;"></textarea>
                        <button class="btn-primary"
                                style="margin-top: 10px;"
                                @onclick="SaveTaskNotes"
                                disabled="@(isLoading || string.IsNullOrWhiteSpace(taskNotes))">
                            @if (isLoading)
                            {
                                <span>Saving...</span>
                            }
                            else
                            {
                                <span>Add Comment</span>
                            }
                        </button>
                    </div>
                </div>

                <div class="modal-footer">
                    <button @onclick="DeleteTask" class="btn-delete" disabled="@isLoading">Delete</button>
                    <div class="modal-footer-right">
                        <button @onclick="ToggleEditMode" class="btn-secondary" disabled="@isLoading">@(isEditMode ? "Cancel" : "Edit")</button>
                        <button @onclick="SaveTaskChanges" class="btn-primary" disabled="@isLoading">@(isEditMode ? "Save Changes" : "Done")</button>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

<style>

    .comments-list {
        max-height: 300px;
        overflow-y: auto;
        margin-bottom: 15px;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 15px;
        background: #f8f9fa;
    }

    .comment-item {
        padding: 12px;
        margin-bottom: 12px;
        background: white;
        border-radius: 6px;
        border-left: 3px solid #007bff;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

        .comment-item:last-child {
            margin-bottom: 0;
        }

    .comment-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
    }

        .comment-header strong {
            color: #495057;
            font-size: 14px;
            font-weight: 600;
        }

        .comment-header small {
            color: #6c757d;
            font-size: 12px;
        }

    .comment-text {
        margin: 0;
        color: #212529;
        line-height: 1.5;
        font-size: 14px;
    }

    .no-comments {
        color: #6c757d;
        font-style: italic;
        text-align: center;
        padding: 20px;
        background: #f8f9fa;
        border-radius: 6px;
        margin-bottom: 15px;
    }

    .btn-icon {
        background: none;
        border: none;
        cursor: pointer;
        font-size: 14px;
        padding: 4px 8px;
        margin-left: 8px;
        opacity: 0.7;
        transition: opacity 0.2s;
    }

        .btn-icon:hover {
            opacity: 1;
        }

    .btn-icon-danger:hover {
        opacity: 1;
        filter: brightness(1.2);
    }

    .btn-small {
        padding: 6px 12px;
        font-size: 14px;
    }

    .comment-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
    }

        .comment-header > div {
            display: flex;
            align-items: center;
        }
</style>

@code {
    private List<TaskItem> tasks = new();
    private List<CommentItem> taskComments = new();
    private string searchQuery = "";
    private string filterSubject = "";
    private bool showCreateModal = false;
    private bool showFilterDropdown = false;
    private TaskItem? selectedTask = null;
    private string selectedTaskStatus = "";
    private string taskNotes = "";
    private bool isEditMode = false;
    private string editTaskName = "";
    private string editTaskDescription = "";
    private string editTaskSubject = "";
    private DateTime? editTaskDueDate;
    private bool isLoading = false;
    private string errorMessage = "";

    private string newTaskName = "";
    private string newTaskDescription = "";
    private string newTaskSubject = "";
    private DateTime? newTaskDueDate;
    private int newTaskReminderDays = 2;

    private int? editingCommentId = null;
    private string editingCommentText = "";


    protected override async System.Threading.Tasks.Task OnInitializedAsync()
    {
        if (!AuthState.IsAuthenticated)
        {
            Navigation.NavigateTo("/login");
            return;
        }

        await LoadTasks();
    }

    private async System.Threading.Tasks.Task LoadTasks()
    {
        if (!AuthState.UserId.HasValue) return;
        errorMessage = "";

        try
        {
            isLoading = true;
            tasks = await TaskService.GetUserTasksAsync(AuthState.UserId.Value);
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to load tasks: {ex.Message}";
            Console.WriteLine($"Error loading tasks: {ex}");
            tasks = new List<TaskItem>();
        }
        finally
        {
            isLoading = false;
        }
    }

    private async System.Threading.Tasks.Task LoadCommentsForTask(int taskId)
    {
        try
        {
            taskComments = await TaskService.GetTaskCommentsAsync(taskId);
            Console.WriteLine($"Loaded {taskComments.Count} comments for task {taskId}");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading comments: {ex.Message}");
            taskComments = new List<CommentItem>();
        }
    }

    private IEnumerable<string> GetUniqueSubjects()
    {
        return tasks
            .Where(t => !string.IsNullOrEmpty(t.Subject))
            .Select(t => t.Subject)
            .Distinct()
            .OrderBy(s => s);
    }

    private IEnumerable<TaskItem> GetTasksByStatus(string status)
    {
        return tasks
            .Where(t => t.Status == status &&
                        (string.IsNullOrEmpty(searchQuery) || t.Name.Contains(searchQuery, StringComparison.OrdinalIgnoreCase)) &&
                        (string.IsNullOrEmpty(filterSubject) || t.Subject == filterSubject));
    }

    private void ToggleFilterDropdown()
    {
        showFilterDropdown = !showFilterDropdown;
    }

    private void CloseFilterDropdown()
    {
        showFilterDropdown = false;
    }

    private void SetFilter(string subject)
    {
        filterSubject = subject;
        showFilterDropdown = false;
        StateHasChanged(); 
    }

    private void HandleFilterAll() => SetFilter("");

    private void OpenCreateTaskModal()
    {
        errorMessage = "";
        showCreateModal = true;
        ResetCreateForm();
    }

    private void CloseCreateTaskModal()
    {
        showCreateModal = false;
        ResetCreateForm();
    }

    private void ResetCreateForm()
    {
        newTaskName = "";
        newTaskDescription = "";
        newTaskSubject = "";
        newTaskDueDate = null;
        newTaskReminderDays = 2;
    }

    private async System.Threading.Tasks.Task OpenTaskDetails(TaskItem task)
    {
        errorMessage = "";
        selectedTask = task;
        selectedTaskStatus = task.Status;
        taskNotes = "";
        isEditMode = false;
        editingCommentId = null;
        editingCommentText = "";

        editTaskName = task.Name;
        editTaskDescription = task.Description;
        editTaskSubject = task.Subject;
        editTaskDueDate = task.DueDate;

        await LoadCommentsForTask(task.Id);
    }

    private void CloseTaskDetails()
    {
        selectedTask = null;
        taskNotes = "";
        isEditMode = false;
        taskComments = new List<CommentItem>();
        editingCommentId = null;
        editingCommentText = "";
    }

    private async System.Threading.Tasks.Task CreateNewTask()
    {
        if (string.IsNullOrWhiteSpace(newTaskName) || string.IsNullOrWhiteSpace(newTaskSubject))
            return;
        if (!AuthState.UserId.HasValue) return;

        try
        {
            isLoading = true;
            await TaskService.CreateTaskAsync(
                AuthState.UserId.Value,
                newTaskName,
                newTaskDescription,
                newTaskSubject,
                newTaskDueDate ?? DateTime.Now.AddDays(7),
                Status.InProgress
            );

            await LoadTasks();
            CloseCreateTaskModal();
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to create task: {ex.Message}";
            Console.WriteLine($"Error creating task: {ex}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private void ToggleEditMode()
    {
        isEditMode = !isEditMode;
        if (!isEditMode && selectedTask != null)
        {
            editTaskName = selectedTask.Name;
            editTaskDescription = selectedTask.Description;
            editTaskSubject = selectedTask.Subject;
            editTaskDueDate = selectedTask.DueDate;
        }
    }

    private async System.Threading.Tasks.Task SaveTaskChanges()
    {
        if (selectedTask == null)
            return;

        try
        {
            isLoading = true;

            await TaskService.UpdateTaskAsync(
                selectedTask.Id,
                isEditMode ? editTaskName : selectedTask.Name,
                isEditMode ? editTaskDescription : selectedTask.Description,
                isEditMode ? editTaskSubject : selectedTask.Subject,
                selectedTaskStatus,
                isEditMode ? editTaskDueDate : selectedTask.DueDate
            );

            await LoadTasks();
            CloseTaskDetails();
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to save changes: {ex.Message}";
            Console.WriteLine($"Error saving task: {ex}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private async System.Threading.Tasks.Task SaveTaskNotes()
    {
        if (selectedTask == null || string.IsNullOrWhiteSpace(taskNotes))
            return;

        if (!AuthState.UserId.HasValue)
        {
            errorMessage = "User not authenticated";
            return;
        }

        try
        {
            isLoading = true;
            errorMessage = "";

            Console.WriteLine($"=== SAVING COMMENT ===");
            Console.WriteLine($"TaskId: {selectedTask.Id}");
            Console.WriteLine($"UserId: {AuthState.UserId.Value}");
            Console.WriteLine($"Description: {taskNotes}");

            await TaskService.CreateCommentAsync(
                taskId: selectedTask.Id,
                userId: AuthState.UserId.Value,
                description: taskNotes
            );

            Console.WriteLine("Comment saved successfully");

            taskNotes = "";
            await LoadCommentsForTask(selectedTask.Id);
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to save comment: {ex.Message}";
            Console.WriteLine($"Error saving comment: {ex}");
            Console.WriteLine($"Stack trace: {ex.StackTrace}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private async System.Threading.Tasks.Task DeleteTask()
    {
        if (selectedTask == null)
            return;

        try
        {
            isLoading = true;
            await TaskService.DeleteTaskAsync(selectedTask.Id);
            await LoadTasks();
            CloseTaskDetails();
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to delete task: {ex.Message}";
            Console.WriteLine($"Error deleting task: {ex}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private void StartEditComment(CommentItem comment)
    {
        editingCommentId = comment.Id;
        editingCommentText = comment.Description;
    }

    private void CancelEditComment()
    {
        editingCommentId = null;
        editingCommentText = "";
    }

    private async System.Threading.Tasks.Task SaveEditComment()
    {
        if (editingCommentId == null || string.IsNullOrWhiteSpace(editingCommentText))
            return;

        try
        {
            isLoading = true;
            errorMessage = "";

            await TaskService.UpdateCommentAsync(editingCommentId.Value, editingCommentText);

            editingCommentId = null;
            editingCommentText = "";

            if (selectedTask != null)
            {
                await LoadCommentsForTask(selectedTask.Id);
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to update comment: {ex.Message}";
            Console.WriteLine($"Error updating comment: {ex}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private async System.Threading.Tasks.Task DeleteComment(int commentId)
    {
        if (!await ConfirmDelete())
            return;

        try
        {
            isLoading = true;
            errorMessage = "";

            await TaskService.DeleteCommentAsync(commentId);

            if (selectedTask != null)
            {
                await LoadCommentsForTask(selectedTask.Id);
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to delete comment: {ex.Message}";
            Console.WriteLine($"Error deleting comment: {ex}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task<bool> ConfirmDelete()
    {
        try
        {
            return await JSRuntime.InvokeAsync<bool>("confirm", "Are you sure you want to delete this comment?");
        }
        catch (Exception)
        {
            return await System.Threading.Tasks.Task.FromResult(true);
        }
    }

    private string GetStatusIcon(TaskItem task)
    {
        if (task.Status == "Done")
        {
            if (task.DueDate.HasValue && task.DueDate.Value.Date < DateTime.Now.Date)
            {
                return "✖";
            }
            return "✓";
        }

        if (!task.DueDate.HasValue)
        {
            return "⚫";
        }

        var daysUntilDue = (task.DueDate.Value.Date - DateTime.Now.Date).Days;

        if (daysUntilDue < 0)
        {
            return "✖";
        }
        else if (daysUntilDue <= 1)
        {
            return "!!";
        }
        else if (daysUntilDue <= 3)
        {
            return "!";
        }
        else if (daysUntilDue <= 7)
        {
            return "○";
        }
        else
        {
            return "⚫";
        }
    }

    private string GetStatusIconColor(TaskItem task)
    {
        if (task.Status == "Done")
        {
            if (task.DueDate.HasValue && task.DueDate.Value.Date < DateTime.Now.Date)
            {
                return "color: #dc3545;";
            }
            return "color: #28a745;";
        }

        if (!task.DueDate.HasValue)
        {
            return "color: var(--color-text-primary);";
        }

        var daysUntilDue = (task.DueDate.Value.Date - DateTime.Now.Date).Days;

        if (daysUntilDue < 0 || daysUntilDue <= 3)
        {
            return "color: #dc3545;";
        }
        else
        {
            return "color: var(--color-text-primary);";
        }
    }
}