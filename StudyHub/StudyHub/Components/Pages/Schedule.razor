@page "/schedule"
@using StudyHub.DAL.Entities
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.Maui.Storage
@inject StudyHub.BLL.Services.ScheduleService ScheduleService
@inject IJSRuntime JS
@using System.Threading.Tasks
@using System.Linq
@using System.IO

<div class="app-container">
    <div class="sidebar">
        <NavLink class="icon-btn" href="/">
            <i class="bi bi-house"></i>
        </NavLink>

        <NavLink class="icon-btn" href="/schedule">
            <i class="bi bi-calendar"></i>
        </NavLink>

        <button class="icon-btn"><i class="bi bi-folder"></i></button>

        <div class="bottom-user">
            <i class="bi bi-person-circle"></i>
        </div>
    </div>

    <div class="main-content">
        <header class="header">
            <h2>Schedule</h2>
        </header>

        <div class="schedule-table">
            <table>
                <thead>
                    <tr>
                        <th></th>
                        @foreach (var day in Days)
                        {
                            <th>@day</th>
                        }
                    </tr>
                </thead>
                <tbody>
                    @foreach (var slot in TimeSlots)
                    {
                        <tr>
                            <td>@slot</td>
                            @foreach (var day in Days)
                            {
                                <td>
                                    @if (RenderedSchedule.ContainsKey(day) && RenderedSchedule[day].ContainsKey(slot))
                                    {
                                        foreach (var lesson in RenderedSchedule[day][slot])
                                        {
                                            <div class="lesson-cell">
                                                <b>@lesson.Subject?.Name</b><br />
                                                <span>@lesson.Type</span><br />
                                                <span>Ауд. @lesson.Room</span><br />
                                                <small>@string.Join(", ", lesson.Lecturer.Select(l => $"{l.Surname} {l.Name}"))</small>
                                            </div>
                                        }
                                    }
                                </td>
                            }
                        </tr>
                    }
                </tbody>
            </table>

            <div class="upload-section">
                <h4>Додай PDF з розкладом</h4>

                <InputFile OnChange="@(async e => await HandleFileUploadAsync(e))" accept=".pdf" />

                @if (!string.IsNullOrEmpty(uploadedFileName))
                {
                    <p>Завантажено: <b>@uploadedFileName</b></p>
                }

                <button class="parse-btn" @onclick="@(async () => await RunParserAsync())">Отримати розклад</button>
            </div>
        </div>
    </div>
</div>

@code {
    private string? uploadedFilePath;
    private string? uploadedFileName;

    private Dictionary<string, Dictionary<string, List<Lesson>>> RenderedSchedule = new();

    private readonly string[] Days =
    {
        "Понеділок", "Вівторок", "Середа", "Четвер", "П’ятниця"
    };

    private readonly string[] TimeSlots =
    {
        "8:30 - 9:50", "10:10 - 11:30", "11:50 - 13:10",
        "13:30 - 14:50", "15:05 - 16:25", "16:40 - 18:00"
    };

    private async System.Threading.Tasks.Task HandleFileUploadAsync(InputFileChangeEventArgs e)
    {
        var file = e.File;
        if (file == null)
        {
            await JS.InvokeVoidAsync("alert", "Файл не вибрано.");
            return;
        }

        if (!file.Name.EndsWith(".pdf", StringComparison.OrdinalIgnoreCase))
        {
            await JS.InvokeVoidAsync("alert", "Будь ласка, виберіть PDF файл.");
            return;
        }

        uploadedFileName = file.Name;
        var folder = Path.Combine(AppContext.BaseDirectory, "Resources", "Schedules");
        Directory.CreateDirectory(folder);

        uploadedFilePath = Path.Combine(folder, uploadedFileName);
        using var fs = new FileStream(uploadedFilePath, FileMode.Create);
        await file.OpenReadStream().CopyToAsync(fs);

        await JS.InvokeVoidAsync("alert", $"Файл {uploadedFileName} успішно завантажено!");
    }

    private async System.Threading.Tasks.Task RunParserAsync()
    {
        if (uploadedFilePath is null)
        {
            await JS.InvokeVoidAsync("alert", "Будь ласка, додай PDF файл!");
            return;
        }

        string groupName = Preferences.Get("GroupName", "ПМІ – 31с");

        try
        {
            var schedule = await ScheduleService.ParseScheduleAsync(uploadedFilePath, groupName);
            await JS.InvokeVoidAsync("alert", $"Розклад для {groupName} успішно отримано! ({schedule.Lessons.Count} занять)");

            RenderedSchedule = schedule.Lessons
                .GroupBy(l => l.Day)
                .ToDictionary(
                    g => g.Key,
                    g => g.GroupBy(l => $"{l.LessonSlot.Start:HH:mm} - {l.LessonSlot.End:HH:mm}")
                          .ToDictionary(sg => sg.Key, sg => sg.ToList())
                );

            StateHasChanged();
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"Помилка: {ex.Message}");
        }
    }
}